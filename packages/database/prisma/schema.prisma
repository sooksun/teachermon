// Prisma Schema for TeacherMon System
// Based on Data Dictionary from doc_ref.pdf

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =============================================
// ENUMS
// =============================================

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Region {
  NORTH
  NORTHEAST
  CENTRAL
  SOUTH
}

enum TeacherStatus {
  ACTIVE
  TRANSFERRED
  RESIGNED
  ON_LEAVE
}

enum SchoolSize {
  SMALL
  MEDIUM
  LARGE
}

enum AreaType {
  REMOTE
  VERY_REMOTE
  SPECIAL
}

enum VisitType {
  LESSON_STUDY
  COACHING
  OBSERVATION
  FOLLOW_UP
}

enum FocusArea {
  CLASSROOM
  MANAGEMENT
  STUDENT_CARE
  COMMUNITY
  PEDAGOGY
}

enum AssessmentPeriod {
  BEFORE
  MID
  AFTER
}

enum CompetencyLevel {
  NEEDS_SUPPORT
  FAIR
  GOOD
  EXCELLENT
}

enum PLCLevel {
  PROVINCIAL
  REGIONAL
  NATIONAL
}

enum PLCRole {
  PARTICIPANT
  PRESENTER
  FACILITATOR
}

enum SupportType {
  COACHING
  TRAINING
  MENTORING
  WORKSHOP
}

enum PlanStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum UserRole {
  TEACHER
  PRINCIPAL
  MENTOR
  PROJECT_MANAGER
  ADMIN
}

// ตัวชี้วัดการเตรียมความพร้อมครูผู้ช่วย (doc_ref6.pdf)
enum IndicatorCode {
  // ด้านวิชาชีพ - ส่วน 1: การจัดการเรียนรู้ (7 ข้อ)
  PRO_1_1  // การวิเคราะห์หลักสูตร
  PRO_1_2  // การออกแบบการจัดการเรียนรู้
  PRO_1_3  // การจัดกิจกรรมการเรียนรู้
  PRO_1_4  // การเลือกและใช้สื่อ เทคโนโลยี
  PRO_1_5  // การวัดและประเมินผล
  PRO_1_6  // การจัดบรรยากาศ
  PRO_1_7  // การใช้เทคโนโลยีดิจิทัล
  // ด้านวิชาชีพ - ส่วน 2: การส่งเสริมสนับสนุน (3 ข้อ)
  PRO_2_1  // การจัดทำข้อมูลสารสนเทศ
  PRO_2_2  // ระบบดูแลช่วยเหลือผู้เรียน
  PRO_2_3  // กฎหมายและระเบียบปฏิบัติ
  // ด้านสังคม (2 ข้อ) - ใช้ครั้งที่ 3-4
  SOC_1    // การเรียนรู้จากกัลยาณมิตร
  SOC_2    // การเรียนรู้เป็นเครือข่าย (PLC)
  // ด้านคุณลักษณะ - ส่วน 1: วินัย คุณธรรม จริยธรรม (11 ข้อ)
  PER_1_1  // มีวินัยในตนเอง
  PER_1_2  // ตรงต่อเวลา
  PER_1_3  // อุทิศเวลาให้แก่ทางราชการและผู้เรียน
  PER_1_4  // เอาใจใส่ช่วยเหลือผู้เรียน
  PER_1_5  // รักษาความสามัคคี
  PER_1_6  // ช่วยเหลือ/ร่วมมือแก่ส่วนรวม
  PER_1_7  // มีส่วนร่วมอนุรักษ์วัฒนธรรมไทย
  PER_1_8  // ดำรงชีวิตตามหลักปรัชญาของเศรษฐกิจพอเพียง
  PER_1_9  // ละเว้นอบายมุขและสิ่งเสพติด
  PER_1_10 // ประพฤติตนเป็นแบบอย่างที่ดี
  PER_1_11 // รักษาชื่อเสียง ปกป้องศักดิ์ศรีวิชาชีพ
  // ด้านคุณลักษณะ - ส่วน 2: การพัฒนาตนเอง (4 ข้อ) - เน้นครั้งที่ 3-4
  PER_2_1  // ภาษาไทยและอังกฤษ
  PER_2_2  // เทคโนโลยีดิจิทัล
  PER_2_3  // การเงิน
  PER_2_4  // สุขภาพ
}

enum EvidenceType {
  LESSON_PLAN      // แผนการสอน
  TEACHING_MEDIA   // สื่อการสอน
  ASSESSMENT       // แบบทดสอบ/การวัดผล
  STUDENT_WORK     // ผลงานนักเรียน
  CLASSROOM_PHOTO  // ภาพกิจกรรมในชั้นเรียน
  REFLECTION       // บันทึกสะท้อนคิด
  ACTION_RESEARCH  // งานวิจัยในชั้นเรียน
  OTHER            // อื่นๆ
}

enum AIActionType {
  JOURNAL_IMPROVE        // ปรับภาษา journal (ช่องเดียว)
  JOURNAL_IMPROVE_MULTI  // ปรับภาษา journal (หลายช่อง)
  JOURNAL_SUGGEST        // แนะนำคำถามสะท้อนคิด
  PDPA_CHECK            // ตรวจ PDPA
  MENTORING_SUMMARY     // สรุปรายงานนิเทศ
  EVIDENCE_SUMMARY      // สรุปเนื้อหาหลักฐาน
  EVIDENCE_TAG          // แนะนำ tag หลักฐาน
  READINESS_EXPLAIN     // อธิบายความพร้อม
  ASSESSMENT_DRAFT      // ร่างข้อความประเมิน
}

enum PDPARiskLevel {
  SAFE              // ปลอดภัย
  LOW_RISK         // เสี่ยงต่ำ
  MEDIUM_RISK      // เสี่ยงปานกลาง
  HIGH_RISK        // เสี่ยงสูง - ต้องแก้ไข
}

enum PortfolioItemType {
  FILE              // ไฟล์ PDF, รูปภาพ
  VIDEO_LINK        // ลิงก์วิดีโอ (YouTube, Google Drive, etc.)
}

enum SelfAssessmentStatus {
  DRAFT             // ร่าง
  SUBMITTED         // ส่งแล้ว
  REVIEWED          // ตรวจสอบแล้ว
}

enum ConsentType {
  DATA_COLLECTION      // การเก็บรวบรวมข้อมูล
  DATA_PROCESSING      // การประมวลผลข้อมูล
  DATA_SHARING         // การเปิดเผยข้อมูล
  MARKETING            // การตลาด
  ANALYTICS            // การวิเคราะห์ข้อมูล
}

enum ConsentStatus {
  PENDING              // รอการยินยอม
  GRANTED              // ยินยอมแล้ว
  REVOKED              // ถอนความยินยอม
  EXPIRED              // หมดอายุ
}

// Budget / Financial Tracking
enum BudgetCategory {
  MENTORING            // ค่าหนุนเสริม/นิเทศ
  PLC                  // ค่ากิจกรรม PLC
  TRAINING             // ค่าอบรม/พัฒนา
  MATERIAL             // ค่าวัสดุ/อุปกรณ์
  TRAVEL               // ค่าเดินทาง
  ACCOMMODATION        // ค่าที่พัก
  FOOD                 // ค่าอาหาร
  PRINTING             // ค่าพิมพ์/เอกสาร
  COMMUNICATION        // ค่าสื่อสาร
  OTHER                // อื่นๆ
}

enum TransactionStatus {
  PENDING              // รออนุมัติ
  APPROVED             // อนุมัติแล้ว
  REJECTED             // ปฏิเสธ
}

// =============================================
// MAIN TABLES
// =============================================

model School {
  id                  String    @id @default(uuid())
  schoolName          String    @map("school_name")
  province            String
  region              Region
  schoolSize          SchoolSize @map("school_size")
  areaType            AreaType  @map("area_type")
  studentTotal        Int       @map("student_total")
  directorName        String?   @map("director_name")
  communityContext    String?   @map("community_context") @db.Text
  qualitySchoolFlag   Boolean   @default(false) @map("quality_school_flag")
  
  // Relations
  teachers            Teacher[]
  indicatorReports    IndicatorReport[] @relation("SchoolIndicatorReports")
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([region])
  @@index([province])
  @@map("school_profile")
}

model Teacher {
  id                  String    @id @default(uuid())
  citizenId           String    @unique @map("citizen_id")
  fullName            String    @map("full_name")
  gender              Gender
  birthDate           DateTime  @map("birth_date")
  cohort              Int       // รุ่นครูรัก(ษ์)ถิ่น
  appointmentDate     DateTime  @map("appointment_date")
  position            String    @default("ครูผู้ช่วย")
  major               String    // วิชาเอก
  email               String?   @unique
  phone               String?
  
  // Foreign Keys
  schoolId            String    @map("school_id")
  school              School    @relation(fields: [schoolId], references: [id])
  
  // Status
  status              TeacherStatus @default(ACTIVE)
  
  // Relations
  mentoringVisits     MentoringVisit[]
  competencyAssessments CompetencyAssessment[]
  selfAssessments     SelfAssessment[]
  reflectiveJournals  ReflectiveJournal[]
  plcActivities       PLCActivity[]
  developmentPlans    DevelopmentPlan[]
  evidencePortfolios  EvidencePortfolio[]
  user                User?
  consents            Consent[]
  indicatorAssessments IndicatorAssessment[] @relation("TeacherIndicatorAssessments")
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([schoolId])
  @@index([status])
  @@index([cohort])
  @@index([schoolId, status])
  @@index([createdAt])
  @@map("teacher_profile")
}

model MentoringVisit {
  id                  String    @id @default(uuid())
  
  // Foreign Keys
  teacherId           String    @map("teacher_id")
  teacher             Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  visitDate           DateTime  @map("visit_date")
  visitType           VisitType @map("visit_type")
  observer            String    // ชื่อทีมหนุนเสริม
  focusArea           FocusArea @map("focus_area")
  
  // Observations
  strengths           String?   @db.Text
  challenges          String?   @db.Text
  suggestions         String?   @db.Text
  followUpRequired    Boolean   @default(false) @map("follow_up_required")
  
  // Attachments (JSON array of file URLs)
  attachments         Json?
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([teacherId])
  @@index([visitDate])
  @@index([teacherId, visitDate])
  @@index([visitType])
  @@map("mentoring_visit")
}

model CompetencyAssessment {
  id                  String    @id @default(uuid())
  
  // Foreign Keys
  teacherId           String    @map("teacher_id")
  teacher             Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  assessmentPeriod    AssessmentPeriod @map("assessment_period")
  
  // Scores (1-5 scale)
  pedagogyScore       Int       @map("pedagogy_score")
  classroomScore      Int       @map("classroom_score")
  communityScore      Int       @map("community_score")
  professionalismScore Int      @map("professionalism_score")
  
  overallLevel        CompetencyLevel @map("overall_level")
  assessor            String    // ผู้ประเมิน
  notes               String?   @db.Text
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([teacherId])
  @@index([assessmentPeriod])
  @@map("competency_assessment")
}

model ReflectiveJournal {
  id                  String    @id @default(uuid())
  
  // Foreign Keys
  teacherId           String    @map("teacher_id")
  teacher             Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  month               String    // YYYY-MM format
  reflectionText      String    @map("reflection_text") @db.Text
  successStory        String?   @map("success_story") @db.Text
  difficulty          String?   @db.Text
  supportRequest      String?   @map("support_request") @db.Text
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@unique([teacherId, month])
  @@index([teacherId])
  @@index([month])
  @@map("reflective_journal")
}

model PLCActivity {
  id                  String    @id @default(uuid())
  
  // Foreign Keys
  teacherId           String    @map("teacher_id")
  teacher             Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  plcDate             DateTime  @map("plc_date")
  plcLevel            PLCLevel  @map("plc_level")
  topic               String
  role                PLCRole
  takeaway            String?   @db.Text // สิ่งที่ได้เรียนรู้
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([teacherId])
  @@index([plcDate])
  @@index([teacherId, plcDate])
  @@index([plcLevel])
  @@map("plc_activity")
}

model DevelopmentPlan {
  id                  String    @id @default(uuid())
  
  // Foreign Keys
  teacherId           String    @map("teacher_id")
  teacher             Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  focusCompetency     String    @map("focus_competency") // ด้านที่ต้องพัฒนา
  actionPlan          String    @map("action_plan") @db.Text
  supportType         SupportType @map("support_type")
  
  startDate           DateTime  @map("start_date")
  endDate             DateTime  @map("end_date")
  progressStatus      PlanStatus @map("progress_status") @default(DRAFT)
  progressNotes       String?   @map("progress_notes") @db.Text

  // Budget tracking (Objective 2: monitor plan & money)
  budgetAllocated     Decimal?  @map("budget_allocated") @db.Decimal(15, 2) // งบประมาณที่จัดสรร (บาท)
  budgetUsed          Decimal?  @map("budget_used") @db.Decimal(15, 2)      // งบที่ใช้ไป (บาท)
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([teacherId])
  @@index([progressStatus])
  @@index([teacherId, progressStatus])
  @@map("development_plan")
}

model PolicyInsight {
  id                  String    @id @default(uuid())
  
  period              Int       @default(2025) // Year
  keyIssue            String    @map("key_issue") @db.Text
  systemicBarrier     String?   @map("systemic_barrier") @db.Text
  successfulPractice  String?   @map("successful_practice") @db.Text
  policyRecommendation String?  @map("policy_recommendation") @db.Text
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@map("policy_insight")
}

// =============================================
// AUTHENTICATION & USERS
// =============================================

model User {
  id                  String    @id @default(uuid())
  email               String    @unique
  password            String    // Hashed password
  role                UserRole  @default(TEACHER)
  
  // Optional relation to Teacher (if user is a teacher)
  teacherId           String?   @unique @map("teacher_id")
  teacher             Teacher?  @relation(fields: [teacherId], references: [id])
  
  // For other roles (Principal, Mentor, etc.)
  fullName            String?   @map("full_name")
  
  isActive            Boolean   @default(true) @map("is_active")
  lastLogin           DateTime? @map("last_login")
  
  // Relations
  consents            Consent[]
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

// =============================================
// AI & EVIDENCE PORTFOLIO TABLES
// =============================================

model SelfAssessment {
  id                  String    @id @default(uuid())
  
  // Foreign Keys
  teacherId           String    @map("teacher_id")
  teacher             Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  // Assessment Period
  assessmentPeriod    AssessmentPeriod @map("assessment_period")
  assessmentDate      DateTime  @default(now()) @map("assessment_date")
  
  // Self-Assessment Scores (1-5 scale)
  pedagogyScore       Int       @map("pedagogy_score")
  classroomScore      Int       @map("classroom_score")
  communityScore      Int       @map("community_score")
  professionalismScore Int      @map("professionalism_score")
  
  // Self-Reflection
  pedagogyReflection  String?   @map("pedagogy_reflection") @db.Text
  classroomReflection String?   @map("classroom_reflection") @db.Text
  communityReflection String?   @map("community_reflection") @db.Text
  professionalismReflection String? @map("professionalism_reflection") @db.Text
  
  // Overall
  overallLevel        CompetencyLevel @map("overall_level")
  strengths           String?   @db.Text // จุดเด่น
  areasForImprovement String?   @map("areas_for_improvement") @db.Text // จุดที่ต้องพัฒนา
  actionPlan          String?   @map("action_plan") @db.Text // แผนการพัฒนา
  
  // Status
  status              SelfAssessmentStatus @default(DRAFT)
  submittedAt         DateTime? @map("submitted_at")
  
  // Mentor/Supervisor Review
  reviewedBy          String?   @map("reviewed_by") // user_id of reviewer
  reviewedAt          DateTime? @map("reviewed_at")
  reviewerComments    String?   @map("reviewer_comments") @db.Text
  
  // Relations
  portfolioItems      EvidencePortfolio[]
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([teacherId])
  @@index([assessmentPeriod])
  @@index([status])
  @@map("self_assessment")
}

model EvidencePortfolio {
  id                  String    @id @default(uuid())
  
  // Foreign Keys
  teacherId           String    @map("teacher_id")
  teacher             Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  selfAssessmentId    String?   @map("self_assessment_id") // เชื่อมกับการประเมินตนเอง
  selfAssessment      SelfAssessment? @relation(fields: [selfAssessmentId], references: [id], onDelete: SetNull)
  
  // Item Type & Content
  itemType            PortfolioItemType @default(FILE) @map("item_type")
  
  // File Information (for FILE type)
  originalFilename    String?   @map("original_filename")
  standardFilename    String?   @map("standard_filename") // AI-generated standardized name
  fileUrl             String?   @map("file_url")
  fileSize            Int?      @map("file_size") // in bytes
  mimeType            String?   @map("mime_type")
  
  // Video Link Information (for VIDEO_LINK type)
  videoUrl            String?   @map("video_url")
  videoTitle          String?   @map("video_title")
  videoDescription    String?   @map("video_description") @db.Text
  videoPlatform       String?   @map("video_platform") // youtube, google_drive, vimeo, etc.
  
  // Evidence Classification
  evidenceType        EvidenceType @map("evidence_type")
  indicatorCodes      Json      @map("indicator_codes") // Array of IndicatorCode - AI suggested
  
  // AI-Generated Content
  aiSummary           String?   @map("ai_summary") @db.Text // 3-5 บรรทัดสรุปเนื้อหา
  aiKeywords          Json?     @map("ai_keywords") // Array of keywords
  aiQualityCheck      Json?     @map("ai_quality_check") // {hasObjective: true, hasSteps: true, ...}
  aiSuggestions       String?   @map("ai_suggestions") @db.Text // ข้อเสนอแนะปรับปรุง
  
  // Metadata
  uploadedBy          String    @map("uploaded_by") // user_id
  isVerified          Boolean   @default(false) @map("is_verified") // ตรวจสอบโดยคนแล้ว
  verifiedBy          String?   @map("verified_by")
  verifiedAt          DateTime? @map("verified_at")
  
  // PDPA Check
  pdpaChecked         Boolean   @default(false) @map("pdpa_checked")
  pdpaRiskLevel       PDPARiskLevel? @map("pdpa_risk_level")
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([teacherId])
  @@index([evidenceType])
  @@index([selfAssessmentId])
  @@map("evidence_portfolio")
}

model AIActivity {
  id                  String    @id @default(uuid())
  
  // User & Context
  userId              String    @map("user_id")
  actionType          AIActionType @map("action_type")
  
  // Input/Output
  inputData           String    @map("input_data") @db.Text
  outputData          String    @map("output_data") @db.Text
  
  // AI Model Info
  modelUsed           String    @map("model_used") @default("gpt-4o-mini") // or "claude-3-haiku"
  tokensUsed          Int?      @map("tokens_used")
  confidenceScore     Float?    @map("confidence_score") // 0.0 - 1.0
  
  // Human Review
  isReviewed          Boolean   @default(false) @map("is_reviewed")
  reviewedBy          String?   @map("reviewed_by")
  reviewedAt          DateTime? @map("reviewed_at")
  reviewNotes         String?   @map("review_notes") @db.Text
  
  // Approval Status
  isApproved          Boolean?  @map("is_approved") // null = pending, true = approved, false = rejected
  
  // Related Entity (optional)
  relatedEntityType   String?   @map("related_entity_type") // "journal", "mentoring_visit", "evidence"
  relatedEntityId     String?   @map("related_entity_id")
  
  createdAt           DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([actionType])
  @@index([createdAt])
  @@map("ai_activity")
}

model PDPAAudit {
  id                  String    @id @default(uuid())
  
  // Context
  sourceType          String    @map("source_type") // "journal", "evidence", "mentoring_visit"
  sourceId            String    @map("source_id")
  
  // Check Results
  originalText        String    @map("original_text") @db.Text
  riskLevel           PDPARiskLevel @map("risk_level")
  violations          Json      @map("violations") // Array of {type, pattern, suggestion}
  
  // Sanitization
  sanitizedText       String?   @map("sanitized_text") @db.Text
  wasAutoFixed        Boolean   @default(false) @map("was_auto_fixed")
  
  // Review
  checkedBy           String    @map("checked_by") // user_id
  isAcknowledged      Boolean   @default(false) @map("is_acknowledged")
  acknowledgedBy      String?   @map("acknowledged_by")
  acknowledgedAt      DateTime? @map("acknowledged_at")
  
  createdAt           DateTime  @default(now()) @map("created_at")

  @@index([sourceType, sourceId])
  @@index([riskLevel])
  @@index([createdAt])
  @@map("pdpa_audit")
}

model Consent {
  id                  String          @id @default(uuid())
  userId              String          @map("user_id")
  teacherId           String?         @map("teacher_id")
  consentType         ConsentType     @map("consent_type")
  status              ConsentStatus   @default(PENDING)
  
  // Consent Details
  grantedAt           DateTime?       @map("granted_at")
  revokedAt           DateTime?       @map("revoked_at")
  expiresAt          DateTime?       @map("expires_at")
  
  // Legal
  privacyPolicyVersion String?        @map("privacy_policy_version")
  termsVersion        String?         @map("terms_version")
  ipAddress           String?         @map("ip_address")
  userAgent           String?         @map("user_agent")
  
  // Relations
  user                User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  teacher             Teacher?        @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  
  @@unique([userId, consentType])
  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("consent")
}

// =============================================
// BUDGET / FINANCIAL TRACKING
// =============================================

model ProjectBudget {
  id                  String    @id @default(uuid())
  fiscalYear          String    @map("fiscal_year")       // ปีงบประมาณ เช่น "2569"
  name                String                              // ชื่องบ เช่น "งบโครงการครูรัก(ษ์)ถิ่น ปี 2569"
  totalAllocated      Decimal   @map("total_allocated") @db.Decimal(15, 2)  // งบจัดสรรรวม
  fundingSource       String?   @map("funding_source")    // แหล่งเงิน
  description         String?   @db.Text                  // รายละเอียด
  isActive            Boolean   @default(true) @map("is_active")

  createdBy           String?   @map("created_by")        // user_id
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  transactions        BudgetTransaction[]

  @@index([fiscalYear])
  @@index([isActive])
  @@map("project_budget")
}

model BudgetTransaction {
  id                  String    @id @default(uuid())

  // FK to project budget
  projectBudgetId     String    @map("project_budget_id")
  projectBudget       ProjectBudget @relation(fields: [projectBudgetId], references: [id], onDelete: Cascade)

  transactionDate     DateTime  @map("transaction_date")
  amount              Decimal   @map("amount") @db.Decimal(15, 2)
  category            BudgetCategory
  description         String    @db.Text                  // รายละเอียดรายจ่าย
  recipient           String?                             // ผู้รับเงิน

  // Receipt
  receiptNumber       String?   @map("receipt_number")    // เลขที่ใบเสร็จ
  receiptFile         String?   @map("receipt_file")      // URL ไฟล์แนบ

  // Link to existing activities (optional)
  relatedActivityType String?   @map("related_activity_type") // MENTORING, PLC, TRAINING
  relatedActivityId   String?   @map("related_activity_id")

  // Approval workflow
  status              TransactionStatus @default(PENDING)
  createdBy           String    @map("created_by")        // user_id ผู้บันทึก
  approvedBy          String?   @map("approved_by")       // user_id ผู้อนุมัติ
  approvedAt          DateTime? @map("approved_at")
  rejectionReason     String?   @map("rejection_reason") @db.Text

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([projectBudgetId])
  @@index([category])
  @@index([status])
  @@index([transactionDate])
  @@index([createdBy])
  @@index([projectBudgetId, status])
  @@map("budget_transaction")
}

// =============================================
// INDICATOR SYSTEM (ตัวชี้วัดการเตรียมความพร้อมครูผู้ช่วย)
// Based on doc_ref6.pdf
// =============================================

// ด้าน (aspect) ของตัวชี้วัด
enum IndicatorAspect {
  PROFESSIONAL  // ด้านวิชาชีพ
  SOCIAL        // ด้านสังคม
  PERSONAL      // ด้านคุณลักษณะส่วนบุคคล
}

model Indicator {
  id          String   @id @default(uuid())
  code        String   @unique // PRO_1, PRO_2, SOC, PER_1, PER_2
  name        String   // ชื่อตัวชี้วัดหลัก
  description String   @db.Text // คำอธิบาย
  
  // หมวดหมู่
  aspect      IndicatorAspect // ด้าน (วิชาชีพ, สังคม, คุณลักษณะส่วนบุคคล)
  section     String?  // ส่วนที่ (เช่น "การจัดการเรียนรู้", "การส่งเสริมสนับสนุน")
  subSection  String?  @map("sub_section") // หมวดย่อย (เช่น "วินัยและการประพฤติตน", "การเสียสละและแบบอย่าง")
  
  // การประเมิน
  assessmentRounds Json @default("[1,2,3,4]") @map("assessment_rounds") // ครั้งที่ใช้ประเมิน [1,2,3,4] หรือ [3,4]
  minPassCount Int?     @map("min_pass_count") // จำนวนข้อขั้นต่ำที่ต้องผ่าน
  
  order       Int      @default(0) // ลำดับการแสดงผล
  isActive    Boolean  @default(true) @map("is_active")
  
  // Relations
  subIndicators SubIndicator[] @relation("IndicatorSubIndicators")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("indicators")
  @@index([code])
  @@index([aspect])
  @@index([isActive])
}

model SubIndicator {
  id          String   @id @default(uuid())
  code        String   @unique // PRO_1.1, PRO_1.2, SOC_1, PER_1.1, etc.
  name        String   // ชื่อตัวชี้วัดย่อย
  description String   @db.Text // คำอธิบาย
  requirements String  @db.Text // สิ่งที่ต้องปฏิบัติ (bullet points)
  assessmentMethods String? @db.Text @map("assessment_methods") // วิธีการประเมิน
  evidenceExamples Json? @map("evidence_examples") // ตัวอย่างเอกสารหลักฐาน (Array)
  
  // การประเมิน
  assessmentRounds Json @default("[1,2,3,4]") @map("assessment_rounds") // ครั้งที่ใช้ประเมิน
  
  order       Int      @default(0) // ลำดับการแสดงผล
  
  // Relations
  indicatorId String   @map("indicator_id")
  indicator   Indicator @relation("IndicatorSubIndicators", fields: [indicatorId], references: [id], onDelete: Cascade)
  
  isActive    Boolean  @default(true) @map("is_active")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("sub_indicators")
  @@index([indicatorId])
  @@index([code])
  @@index([isActive])
}

// ผลการประเมินตัวชี้วัด (สำหรับครูผู้ช่วยแต่ละคน)
model IndicatorAssessment {
  id              String   @id @default(uuid())
  
  // ครูผู้ช่วยที่ถูกประเมิน
  teacherId       String   @map("teacher_id")
  teacher         Teacher  @relation("TeacherIndicatorAssessments", fields: [teacherId], references: [id], onDelete: Cascade)
  
  // ครั้งที่ประเมิน (1-4)
  assessmentRound Int      @map("assessment_round")
  
  // วันที่ประเมิน
  assessmentDate  DateTime @map("assessment_date")
  
  // ผู้ประเมิน
  assessorId      String?  @map("assessor_id")
  
  // สรุปผลตามด้าน
  professionalPassed  Int  @default(0) @map("professional_passed") // จำนวนข้อที่ผ่าน ด้านวิชาชีพ
  professionalTotal   Int  @default(10) @map("professional_total")
  socialPassed        Int  @default(0) @map("social_passed") // จำนวนข้อที่ผ่าน ด้านสังคม
  socialTotal         Int  @default(2) @map("social_total")
  personalPassed      Int  @default(0) @map("personal_passed") // จำนวนข้อที่ผ่าน ด้านคุณลักษณะ
  personalTotal       Int  @default(15) @map("personal_total")
  
  // ผลการประเมินรวม
  overallResult   String?  @map("overall_result") // ผ่าน/ไม่ผ่าน
  comments        String?  @db.Text // ความคิดเห็นเพิ่มเติม
  
  // รายละเอียดการประเมินแต่ละตัวชี้วัด (JSON Array)
  // Format: [{ code: "PRO_1.1", passed: true, score: 3, evidence: "..." }, ...]
  assessmentDetails Json?  @map("assessment_details")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("indicator_assessments")
  @@unique([teacherId, assessmentRound])
  @@index([teacherId])
  @@index([assessmentRound])
  @@index([assessmentDate])
}

// สรุปรายงานตามหมวดหมู่ตัวชี้วัด (สำหรับโรงเรียน)
model IndicatorReport {
  id              String   @id @default(uuid())
  
  // โรงเรียน
  schoolId        String   @map("school_id")
  school          School   @relation("SchoolIndicatorReports", fields: [schoolId], references: [id], onDelete: Cascade)
  
  // ครั้งที่ประเมิน
  assessmentRound Int      @map("assessment_round")
  
  // ปีการศึกษา
  academicYear    String   @map("academic_year") // เช่น "2568"
  
  // วันที่สร้างรายงาน
  reportDate      DateTime @default(now()) @map("report_date")
  
  // สรุปภาพรวม
  totalTeachers       Int  @default(0) @map("total_teachers")
  passedTeachers      Int  @default(0) @map("passed_teachers")
  failedTeachers      Int  @default(0) @map("failed_teachers")
  
  // สรุปตามด้าน (เฉลี่ย %)
  professionalAvgPercent Float @default(0) @map("professional_avg_percent")
  socialAvgPercent       Float @default(0) @map("social_avg_percent")
  personalAvgPercent     Float @default(0) @map("personal_avg_percent")
  
  // รายละเอียดแยกตามตัวชี้วัด
  // Format: { "PRO_1.1": { passCount: 10, totalCount: 12 }, ... }
  indicatorBreakdown Json? @map("indicator_breakdown")
  
  // ข้อเสนอแนะ
  recommendations String? @db.Text
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("indicator_reports")
  @@unique([schoolId, assessmentRound, academicYear])
  @@index([schoolId])
  @@index([assessmentRound])
  @@index([academicYear])
}

// =============================================
// VIDEO ANALYSIS (AI วิเคราะห์ชิ้นงาน)
// =============================================

enum AnalysisMode {
  TEXT_ONLY    // ASR -> transcript -> AI analysis only
  FULL         // ASR + frame extraction -> multimodal analysis
}

enum AnalysisJobStatus {
  UPLOADING
  UPLOADED
  QUEUED
  PROCESSING_ASR
  ASR_DONE
  PROCESSING_FRAMES
  ANALYZING
  DONE
  FAILED
  REJECTED_QUOTA
}

enum AnalysisSourceType {
  UPLOAD       // direct file upload
  GDRIVE       // Google Drive file
  YOUTUBE      // YouTube URL
}

model AnalysisJob {
  id                  String             @id @default(uuid())

  // Owner
  userId              String             @map("user_id")
  teacherId           String?            @map("teacher_id")

  // Job config
  analysisMode        AnalysisMode       @default(TEXT_ONLY) @map("analysis_mode")
  sourceType          AnalysisSourceType @default(UPLOAD) @map("source_type")
  status              AnalysisJobStatus  @default(UPLOADING)

  // Original file info
  originalFilename    String?            @map("original_filename")
  mimeType            String?            @map("mime_type")

  // Byte accounting (for quota)
  rawBytes            Int                @default(0) @map("raw_bytes")
  audioBytes          Int                @default(0) @map("audio_bytes")
  framesBytes         Int                @default(0) @map("frames_bytes")
  totalBytes          Int                @default(0) @map("total_bytes")

  // Error info
  errorMessage        String?            @map("error_message") @db.Text
  errorCode           String?            @map("error_code")

  // Artifact flags / paths (relative to job dir)
  hasTranscript       Boolean            @default(false) @map("has_transcript")
  hasFrames           Boolean            @default(false) @map("has_frames")
  hasReport           Boolean            @default(false) @map("has_report")
  hasCover            Boolean            @default(false) @map("has_cover")

  // AI analysis results (stored in DB for quick access)
  transcriptSummary   String?            @map("transcript_summary") @db.Text
  analysisReport      Json?              @map("analysis_report")
  evaluationResult    Json?              @map("evaluation_result")
  aiAdvice            String?            @map("ai_advice") @db.Text

  // Timestamps
  uploadedAt          DateTime?          @map("uploaded_at")
  queuedAt            DateTime?          @map("queued_at")
  asrStartedAt        DateTime?          @map("asr_started_at")
  asrDoneAt           DateTime?          @map("asr_done_at")
  framesStartedAt     DateTime?          @map("frames_started_at")
  framesDoneAt        DateTime?          @map("frames_done_at")
  analysisDoneAt      DateTime?          @map("analysis_done_at")
  doneAt              DateTime?          @map("done_at")

  // Retention (FULL mode: keep frames 1 year)
  framesExpiresAt     DateTime?          @map("frames_expires_at")
  framesDeletedAt     DateTime?          @map("frames_deleted_at")

  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")

  @@index([userId])
  @@index([teacherId])
  @@index([status])
  @@index([createdAt])
  @@index([framesExpiresAt])
  @@map("analysis_job")
}

model UserMediaQuota {
  id                  String    @id @default(uuid())
  userId              String    @unique @map("user_id")

  limitBytes          BigInt    @default(1073741824) @map("limit_bytes")  // 1 GB default
  usageBytes          BigInt    @default(0) @map("usage_bytes")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@map("user_media_quota")
}
