# ============================================
# TeacherMon - Production Docker Compose
# Server: Ubuntu @ /DATA/AppData/www/rukthin
# Database: External MariaDB 11.4 @ 192.168.1.4
# Ports: API=9904, Web=9903 (ไม่ชนกับ CasaOS)
# ============================================
# Usage:
#   cd /DATA/AppData/www/rukthin
#   docker compose -f docker-compose.prod.yml --env-file .env.production up -d --build
# ============================================

services:
  # ---- Redis (Queue for video analysis) ----
  redis:
    image: redis:7-alpine
    container_name: teachermon-redis
    restart: always
    networks:
      - teachermon-net
    volumes:
      - redis-data:/data
    logging:
      driver: 'json-file'
      options:
        max-size: '5m'
        max-file: '3'

  # ---- NestJS API ----
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    image: teachermon-api:latest
    container_name: teachermon-api
    env_file:
      - .env.production
    environment:
      NODE_ENV: production
      PORT: 3001
      REDIS_URL: redis://redis:6379/0
      ANALYSIS_DATA_ROOT: /data/jobs
    # โฟลเดอร์ uploads ต้อง chown 1000:1000 บน host (user node ใน container)
    # รันครั้งเดียว: sudo chown -R 1000:1000 uploads
    volumes:
      - ./uploads:/app/apps/api/uploads
      - analyze-data:/data
    ports:
      - '9904:3001'
    depends_on:
      - redis
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    restart: always
    networks:
      - teachermon-net
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3001/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '5'

  # ---- Next.js Web ----
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-/api}
    image: teachermon-web:latest
    container_name: teachermon-web
    environment:
      NODE_ENV: production
    # Mount uploads directory (read-only) เพื่อเสิร์ฟรูปภาพผ่าน Next.js
    # ไม่ต้องผ่าน NestJS API → ไม่โดน rate limit
    volumes:
      - ./uploads:/app/uploads:ro
    ports:
      - '9903:3000'
    depends_on:
      api:
        condition: service_healthy
    restart: always
    networks:
      - teachermon-net
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

volumes:
  redis-data:
  analyze-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${ANALYZE_DATA_PATH:-/DATA/AppData/teach-analyze/data}

networks:
  teachermon-net:
    driver: bridge
